name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      cleanup:
        description: 'Clean up persistent directories before deploying'
        required: false
        type: boolean
        default: false
  release:
    types: [published]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          set -e
          
          # Create temporary directory for new files
          TEMP_DIR=$(mktemp -d)
          
          # Create directory structure in temp
          mkdir -p "$TEMP_DIR"/{etc/pihole,etc/dnsmasq.d,etc/wireguard,scripts}
          
          # Copy all files to temp directory first
          echo "ğŸ“‚ Copying files to temporary location..."
          find . -mindepth 1 -maxdepth 1 -not -name '.git' -not -name '.github' -not -name '.gitignore' -not -name '.env' -exec cp -r --no-preserve=all --remove-destination {} "$TEMP_DIR"/ \;
          
          # Copy docker-compose.yml if it exists
          if [ -f "docker-compose.yml" ]; then
            cp --no-preserve=all --remove-destination docker-compose.yml "$TEMP_DIR"/
          fi
          
          # Create target directory structure
          mkdir -p /docker/wgpihole
          
          # If cleanup is requested, remove everything except .env
          if [[ "${{ github.event_name == 'release' || github.event.inputs.cleanup }}" == "true" ]]; then
            echo "ğŸ§¹ Cleaning up persistent directories..."
            cd /docker/wgpihole
            # Delete everything except .env
            find . -mindepth 1 -not -path './.env' -delete
          fi
          
          # Move files from temp to target
          echo "ğŸšš Moving files to target location..."
          cp -r "$TEMP_DIR"/. /docker/wgpihole/
          
          # Set secure permissions (suppress errors for container-managed files)
          chmod -R 750 /docker/wgpihole/ 2>/dev/null || true
          chmod 640 /docker/wgpihole/.env 2>/dev/null || true
      
      - name: Verify .env file
        run: |
          cd /docker/wgpihole
          
          if [ ! -f .env ]; then
            echo "âŒ Error: .env file not found in /docker/wgpihole"
            echo "Please create the .env file on the VPS with the following required variables:"
            echo "- TZ"
            echo "- WG_HOST"
            echo "- WG_PORT"
            echo "- WG_ALLOWED_IPS"
            echo "- PIHOLE_WEBPASSWORD"
            echo "- WGEASY_PASSWORD_HASH"
            exit 1
          fi
          
          
          # Verify required variables are present
          for var in TZ WG_HOST WG_PORT WG_ALLOWED_IPS PIHOLE_WEBPASSWORD WGEASY_PASSWORD_HASH; do
            if ! grep -q "^$var=" .env; then
              echo "âŒ Error: Required variable $var is missing from .env"
              exit 1
            fi
          done
          
          echo "âœ… All required variables are present in .env"

      - name: Inject Pi-hole password directly into docker-compose.yml
        run: |
          cd /docker/wgpihole
          
          # Extract the password value (strip surrounding quotes if present)
          PIHOLE_PASS=$(grep "^PIHOLE_WEBPASSWORD=" .env | cut -d '=' -f2- | sed 's/^["'"'"']//;s/["'"'"']$//')
          
          if [ -z "$PIHOLE_PASS" ]; then
            echo "âŒ Failed to extract PIHOLE_WEBPASSWORD from .env"
            exit 1
          fi
          
          echo "ğŸ”‘ Injecting hardcoded WEBPASSWORD into docker-compose.yml..."
          
          # Step 1: Remove any existing WEBPASSWORD line (any format, any indentation)
          sed -i '/^\s*WEBPASSWORD[:=]/d' docker-compose.yml
          
          # Step 2: Find the indentation of the environment: line and insert the new line right after it
          # This captures the exact leading whitespace of the environment: line
          if grep -q '^\s*environment:' docker-compose.yml; then
            INDENT=$(grep -m1 '^\s*environment:' docker-compose.yml | sed 's/\(environment:.*$\)//')
            sed -i "/^\s*environment:/a ${INDENT}  WEBPASSWORD: \"$PIHOLE_PASS\"" docker-compose.yml
          else
            echo "âŒ Could not find 'environment:' section in docker-compose.yml"
            exit 1
          fi
          
          # Optional: Show the updated section for debugging
          echo "Updated pihole environment section:"
          grep -A 10 -B 5 "WEBPASSWORD" docker-compose.yml
          
          echo "âœ… WEBPASSWORD is now hardcoded directly in docker-compose.yml"

      - name: Start services
        run: |
          set -e
          cd /docker/wgpihole
          
          # Ensure scripts are executable
          chmod +x scripts/*.sh 2>/dev/null || true
          
          
          # Start services
          echo "ğŸš€ Starting services..."
          docker compose down || true
          docker compose up -d
          
          # Verify services
          echo "ğŸ” Verifying services..."
          sleep 10
          if ! docker compose ps | grep -q "Up"; then
            echo "âŒ Services failed to start!"
            docker compose logs
            exit 1
          fi
          
          
          echo "âœ… Services started successfully!"
