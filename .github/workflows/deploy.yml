name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      cleanup:
        description: 'Clean up persistent directories before deploying'
        required: false
        type: boolean
        default: false
  release:
    types: [published]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          set -e
          
          # Create directory structure
          mkdir -p /docker/wgpihole/{etc/pihole,etc/dnsmasq.d,etc/wireguard,scripts}
          
          # Determine if we should clean up
          if [[ "${{ github.event_name == 'release' || github.event.inputs.cleanup }}" == "true" ]]; then
            echo "ðŸ§¹ Cleaning up persistent directories..."
            cd /docker/wgpihole
            find . -type f \( -not -path './etc/pihole/*' -and -not -path './etc/dnsmasq.d/*' -and -not -path './etc/wireguard/*' \) -delete
          fi
          
          # Copy files with proper permissions
          echo "ðŸ“‚ Copying files..."
          find . -mindepth 1 -maxdepth 1 \( -name '.git' -o -name '.github' -o -name '.gitignore' -o -name '.env' \) -prune -o -exec cp -r --no-preserve=all --remove-destination {} /docker/wgpihole/ \;
          
          # Set secure permissions (suppress errors for container-managed files)
          chmod -R 750 /docker/wgpihole/ 2>/dev/null || true
          chmod 640 /docker/wgpihole/.env 2>/dev/null || true

      - name: Generate .env file
        run: |
          cd /docker/wgpihole
          
          # Write .env file with proper escaping for the password hash
          # Using printf to avoid any interpretation of special characters
          printf 'TZ=%s\n' "${{ vars.TZ }}" > .env
          printf 'WG_HOST=%s\n' "${{ vars.WG_HOST }}" >> .env
          printf 'WG_PORT=%s\n' "${{ vars.WG_PORT }}" >> .env
          printf 'WG_ALLOWED_IPS=%s\n' "${{ vars.WG_ALLOWED_IPS }}" >> .env
          printf 'PIHOLE_WEBPASSWORD=%s\n' "${{ secrets.PIHOLE_WEBPASSWORD }}" >> .env
          
          # Handle the password hash with single quotes to prevent any interpretation
          echo "WGEASY_PASSWORD_HASH='${{ secrets.WGEASY_PASSWORD_HASH }}'" >> .env
          
          # Debug: Show the final .env content
          echo "Final .env content:"
          cat .env
          
          echo "Generated .env file contents:"
          cat .env
          echo ""
          echo "Debug - checking for $ issues:"
          if grep -q '\$2' .env; then
            echo "âœ“ .env contains \$2 (good - bcrypt hash preserved)"
          else
            echo "âœ— .env does NOT contain \$2 (hash may be corrupted)"
            echo "Hex dump of WGEASY line:"
            grep WGEASY_PASSWORD_HASH .env | od -c | head -5
          fi

      - name: Start services
        run: |
          set -e
          cd /docker/wgpihole
          
          # Ensure scripts are executable
          chmod +x scripts/*.sh 2>/dev/null || true
          
          # Debug: Show .env and docker-compose config
          echo "ðŸ” Debug information:"
          echo "=== .env file ==="
          cat .env
          echo "=== docker-compose config ==="
          docker compose config
          echo "=== Checking Pi-hole environment ==="
          docker compose config | grep -A5 -B5 "WEBPASSWORD" || true
          
          # Start services
          echo "ðŸš€ Starting services..."
          docker compose down || true
          docker compose up -d
          
          # Verify services
          echo "ðŸ” Verifying services..."
          sleep 10
          if ! docker compose ps | grep -q "Up"; then
            echo "âŒ Services failed to start!"
            docker compose logs
            exit 1
          fi
          
          # Debug: Check container environment
          echo "=== Container environment check ==="
          docker compose exec -T pihole printenv WEBPASSWORD 2>/dev/null || echo "Could not check Pi-hole env"
          docker compose exec -T wgeasy printenv PASSWORD_HASH 2>/dev/null || echo "Could not check WG-Easy env"
          
          echo "âœ… Services started successfully!"
          echo ""
          echo "ðŸ“Š Service URLs:"
          echo "   Pi-hole Admin: http://${{ vars.WG_HOST }}/admin"
          echo "   WG-Easy Web:  http://${{ vars.WG_HOST }}:51821"