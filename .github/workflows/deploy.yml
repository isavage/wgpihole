name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'Force redeploy even if no changes'
        required: false
        default: 'false'
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

    - name: Check .env file exists
      id: check_env
      run: |
        if ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "test -f /docker/wgpihole/.env"; then
          echo "env_exists=true" >> $GITHUB_OUTPUT
        else
          echo "env_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Handle missing .env file
      if: steps.check_env.outputs.env_exists == 'false'
      run: |
        echo "‚ùå .env file not found on VPS!"
        echo "Please create /docker/wgpihole/.env on your VPS with your configuration."
        echo "Copy .env.example template and fill in your values."
        exit 1

    - name: Create directory structure
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
          mkdir -p /docker/wgpihole/{etc/pihole,etc/dnsmasq.d,etc/wireguard,scripts}
        "

    - name: Deploy files
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
          cd /docker/wgpihole
          
          # Stop existing containers if running
          if docker-compose ps -q | grep -q .; then
            echo 'üõë Stopping existing containers...'
            docker-compose down
          fi
          
          # Copy/overwrite configuration files
          echo ' Deploying configuration files...'
          
          # Copy core files
          # Generate docker-compose.yml with environment variables
          cat > docker-compose.yml << 'EOF_DOCKER_COMPOSE'
version: '3.7'

services:
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    environment:
      - TZ=${{ vars.TZ }}
      - WEBPASSWORD=${{ secrets.PIHOLE_WEBPASSWORD }}
      - ServerIP=${{ vars.WG_HOST }}
    volumes:
      - './etc/pihole/:/etc/pihole/'
      - './etc/dnsmasq.d/:/etc/dnsmasq.d/'
    dns:
      - 1.1.1.1
      - 1.0.0.1
    cap_add:
      - NET_ADMIN
    restart: unless-stopped

  wg-easy:
    image: weejewel/wg-easy:latest
    container_name: wg-easy
    environment:
      - WG_HOST=${{ vars.WG_HOST }}
      - PASSWORD=${{ secrets.WGEASY_PASSWORD_HASH }}
      - WG_ALLOWED_IPS=${{ vars.WG_ALLOWED_IPS }}
      - WG_DEFAULT_ADDRESS=10.8.0.x
      - WG_DEFAULT_DNS=10.8.0.1
    volumes:
      - './etc/wireguard:/etc/wireguard'
    ports:
      - "51820:51820/udp"
      - "51821:51821/tcp"
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    restart: unless-stopped
EOF_DOCKER_COMPOSE
          
          # Generate blocklists.conf
          cat > blocklists.conf << 'EOF_BLOCKLISTS'
$(cat blocklists.conf)
EOF_BLOCKLISTS
          
          # Generate .env file
          cat > .env << 'EOF_ENV'
$(cat .env.example | sed 's|<your_pihole_password_here>|${{ secrets.PIHOLE_WEBPASSWORD }}|g' | sed 's|<your_bcrypt_hash_here>|${{ secrets.WGEASY_PASSWORD_HASH }}|g' | sed 's|<your_public_ip_or_domain>|${{ vars.WG_HOST }}|g' | sed 's|America/New_York|${{ vars.TZ }}|g')
EOF_ENV
          
          # Copy scripts
          cat << 'EOF' > scripts/init-blocklists.sh
$(cat scripts/init-blocklists.sh)
EOF
          chmod +x scripts/init-blocklists.sh
          
          # Copy README
          cat << 'EOF' > README.md
$(cat README.md)
EOF
        "

    - name: Start services
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
          cd /docker/wgpihole
          
          echo 'üöÄ Starting services...'
          docker-compose up -d
          
          # Wait for services to be ready
          echo '‚è≥ Waiting for services to initialize...'
          sleep 30
          
          # Check service status
          if docker-compose ps | grep -q 'Up'; then
            echo '‚úÖ Services started successfully!'
            
            echo ''
            echo 'üìä Service URLs:'
            echo "   Pi-hole Admin: http://${{ secrets.VPS_HOST }}/admin"
            echo "   WG-Easy Web:  http://${{ secrets.VPS_HOST }}:51821"
            echo ''
            echo 'üìù To view logs: docker-compose logs -f'
            echo 'üõë To stop:      docker-compose down'
          else
            echo '‚ùå Services failed to start!'
            docker-compose logs
            exit 1
          fi
        "

    - name: Cleanup old images (optional)
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
          docker image prune -f --filter 'until=72h'
        "
