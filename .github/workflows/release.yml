name: Release Deployment

on:
  release:
    types: [ published ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.release.tag_name }}

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

    - name: Deploy Release
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.WG_HOST }} "
          cd /docker/wgpihole
          
          # Create release directory
          mkdir -p releases/${{ github.event.release.tag_name }}
          cd releases/${{ github.event.release.tag_name }}
          
          # Stop existing containers
          if docker-compose ps -q | grep -q .; then
            echo 'üõë Stopping existing containers...'
            docker-compose down
          fi
          
          # Copy release files
          echo 'üìÅ Deploying release ${{ github.event.release.tag_name }}...'
          
          cat << 'EOF' > docker-compose.yml
$(cat docker-compose.yml | sed 's|${PIHOLE_WEBPASSWORD}|${{ secrets.PIHOLE_WEBPASSWORD }}|g' | sed 's|${WGEASY_PASSWORD_HASH}|${{ secrets.WGEASY_PASSWORD_HASH }}|g' | sed 's|${WG_HOST}|${{ secrets.WG_HOST }}|g' | sed 's|${WG_ALLOWED_IPS}|${{ secrets.WG_ALLOWED_IPS }}|g' | sed 's|${TZ}|${{ secrets.TZ }}|g')
EOF
          
          cat << 'EOF' > blocklists.conf
$(cat blocklists.conf)
EOF
          
          cat << 'EOF' > .env
$(cat .env.example | sed 's|<your_pihole_password_here>|${{ secrets.PIHOLE_WEBPASSWORD }}|g' | sed 's|<your_bcrypt_hash_here>|${{ secrets.WGEASY_PASSWORD_HASH }}|g' | sed 's|<your_public_ip_or_domain>|${{ secrets.WG_HOST }}|g' | sed 's|America/New_York>|${{ secrets.TZ }}|g')
EOF
          
          # Copy scripts
          cat << 'EOF' > scripts/init-blocklists.sh
$(cat scripts/init-blocklists.sh)
EOF
          chmod +x scripts/init-blocklists.sh
          
          # Start services
          echo 'üöÄ Starting release ${{ github.event.release.tag_name }}...'
          docker-compose up -d
          
          # Wait for services to be ready
          echo '‚è≥ Waiting for services to initialize...'
          sleep 30
          
          # Check service status
          if docker-compose ps | grep -q 'Up'; then
            echo '‚úÖ Release ${{ github.event.release.tag_name }} deployed successfully!'
            
            echo ''
            echo 'üìä Service URLs:'
            echo "   Pi-hole Admin: http://${{ secrets.WG_HOST }}/admin"
            echo "   WG-Easy Web:  http://${{ secrets.WG_HOST }}:51821"
            echo ''
            echo 'üìù To view logs: docker-compose logs -f'
            echo 'üõë To stop:      docker-compose down'
          else
            echo '‚ùå Release deployment failed!'
            docker-compose logs
            exit 1
          fi
        "

    - name: Cleanup old images
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.WG_HOST }} "
          docker image prune -f --filter 'until=72h'
        "
