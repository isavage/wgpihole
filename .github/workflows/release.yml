name: Release Deployment

on:
  release:
    types: [ published ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.release.tag_name }}

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

    - name: Deploy Release
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.WG_HOST }} "
          cd /docker/wgpihole
          
          # Create release directory
          mkdir -p releases/${{ github.event.release.tag_name }}
          cd releases/${{ github.event.release.tag_name }}
          
          # Stop existing containers
          if docker-compose ps -q | grep -q .; then
            echo 'üõë Stopping existing containers...'
            docker-compose down
          fi
          
          # Copy release files
          echo 'üìÅ Deploying release ${{ github.event.release.tag_name }}...'
          
          # Generate docker-compose.yml with environment variables
          cat > docker-compose.yml << 'EOF'
version: '3.7'

services:
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    environment:
      - TZ=${{ vars.TZ }}
      - WEBPASSWORD=${{ secrets.PIHOLE_WEBPASSWORD }}
      - ServerIP=${{ vars.WG_HOST }}
    volumes:
      - './etc/pihole/:/etc/pihole/'
      - './etc/dnsmasq.d/:/etc/dnsmasq.d/'
    dns:
      - 1.1.1.1
      - 1.0.0.1
    cap_add:
      - NET_ADMIN
    restart: unless-stopped

  wg-easy:
    image: weejewel/wg-easy:latest
    container_name: wg-easy
    environment:
      - WG_HOST=${{ vars.WG_HOST }}
      - PASSWORD=${{ secrets.WGEASY_PASSWORD_HASH }}
      - WG_ALLOWED_IPS=${{ vars.WG_ALLOWED_IPS }}
      - WG_DEFAULT_ADDRESS=10.8.0.x
      - WG_DEFAULT_DNS=10.8.0.1
    volumes:
      - './etc/wireguard:/etc/wireguard'
    ports:
      - "51820:51820/udp"
      - "51821:51821/tcp"
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    restart: unless-stopped
EOF
          
          cat << 'EOF' > blocklists.conf
$(cat blocklists.conf)
EOF
          
          cat << 'EOF' > .env
$(cat .env.example | sed 's|<your_pihole_password_here>|${{ secrets.PIHOLE_WEBPASSWORD }}|g' | sed 's|<your_bcrypt_hash_here>|${{ secrets.WGEASY_PASSWORD_HASH }}|g' | sed 's|<your_public_ip_or_domain>|${{ vars.WG_HOST }}|g' | sed 's|America/New_York|${{ vars.TZ }}|g')
EOF
          
          # Copy scripts
          cat << 'EOF' > scripts/init-blocklists.sh
$(cat scripts/init-blocklists.sh)
EOF
          chmod +x scripts/init-blocklists.sh
          
          # Start services
          echo 'üöÄ Starting release ${{ github.event.release.tag_name }}...'
          docker-compose up -d
          
          # Wait for services to be ready
          echo '‚è≥ Waiting for services to initialize...'
          sleep 30
          
          # Check service status
          if docker-compose ps | grep -q 'Up'; then
            echo '‚úÖ Release ${{ github.event.release.tag_name }} deployed successfully!'
            
            echo ''
            echo 'üìä Service URLs:'
            echo "   Pi-hole Admin: http://${{ vars.WG_HOST }}/admin"
            echo "   WG-Easy Web:  http://${{ vars.WG_HOST }}:51821"
            echo ''
            echo 'üìù To view logs: docker-compose logs -f'
            echo 'üõë To stop:      docker-compose down'
          else
            echo '‚ùå Release deployment failed!'
            docker-compose logs
            exit 1
          fi
        "

    - name: Cleanup old images
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.WG_HOST }} "
          docker image prune -f --filter 'until=72h'
        "
